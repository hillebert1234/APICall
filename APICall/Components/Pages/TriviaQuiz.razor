@page "/quiz"
@using APICall.Components.Models
@inject APICall.APIService Api
@rendermode InteractiveServer

<h3>Quiz</h3>

@if (isLoading)
{
    <p>Henter spørgsmål…</p>
}
else if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger">@error</div>
}
else if (showResult)
{
    <p>Du fik <strong>@score</strong> ud af <strong>@questions.Count</strong> rigtige.</p>
    <button class="btn btn-primary" @onclick="Reload">Prøv igen</button>
}
else
{
    var quest = questions[currentIndex];

    <p><strong>Spørgsmål @((currentIndex + 1)) / @questions.Count</strong></p>
    <p>@quest.Question</p>

    <div class="answers">
        @for (int i = 0; i < quest.Options.Count; i++)
        {
            var index = i;

            <button class="btn answer-btn"
                    @onclick="() => AnswerAndAdvance(index)">
                @quest.Options[index].Text
            </button>
        }
    </div>

    <div style="margin-top: 0.75rem;">
        <button class="btn btn-secondary"
                disabled="@(currentIndex == 0)"
                @onclick="Prev">
            Tilbage
        </button>
    </div>
}

@code {
    private List<QuizQuestion> questions = new();
    private List<int?> selections = new();
    private int currentIndex;
    private int score;
    private bool isLoading = true;
    private bool showResult;
    private string? error;

    // Henter spørgsmål EFTER første render (krævet i InteractiveServer)
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await Reload();
    }

    private async Task Reload()
    {
        try
        {
            isLoading = true;
            showResult = false;
            currentIndex = 0;
            score = 0;
            error = null;

            questions = await Api.GetTriviaAsync(10);
            selections = Enumerable.Repeat<int?>(null, questions.Count).ToList();
        }
        catch (Exception ex)
        {
            error = $"Kunne ikke hente spørgsmål: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    private void Prev()
    {
        if (currentIndex > 0)
            currentIndex--;
    }
    private void AnswerAndAdvance(int optionIndex)
    {
        var q = questions[currentIndex];

        // Beskyttelse mod edge cases
        if (optionIndex < 0 || optionIndex >= q.Options.Count)
            return;

        selections[currentIndex] = optionIndex;

        if (currentIndex == questions.Count - 1)
        {
            BeregnScore();
            showResult = true;
        }
        else
        {
            currentIndex++;
        }
    }
    private void BeregnScore()
    {
        score = 0;

        for (int i = 0; i < questions.Count; i++)
        {
            var sel = selections[i];
            if (sel.HasValue && questions[i].Options[sel.Value].IsCorrect)
                score++;
        }
    }
}
