@page "/fuel-overview"
@rendermode InteractiveServer
@using APICall.Components.Models
@using BlazorBootstrap
@inject APIService APIService

<h1>Fuel Overview</h1>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <p class="text-danger">@ErrorMessage</p>
}
else if (dieselData == null || gasData == null)
{
    <p>Loading fuel data...</p>
}
else
{
    <!-- Kort med laveste/højeste + liste -->
    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div style="flex: 1; border: 1px solid #ccc; border-radius: 8px; padding: 15px; max-height: 350px; overflow-y: auto; background-color: #f9f9f9;">
            <h3 style="margin-bottom: 10px;">Diesel</h3>
            <p><strong>Billigst:</strong> @MinDieselPrice pr liter (@MinDieselDate)</p>
            <p><strong>Dyrest:</strong> @MaxDieselPrice pr liter (@MaxDieselDate)</p>
            <ul style="list-style: none; padding: 0;">
                @foreach (var diesel in dieselData)
                {
                    <li style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #eee;">
                        <span>@diesel.Date?.ToString("dd-MM-yyyy")</span>
                        <span>@(diesel.PriceValue is null ? "-" : $"{diesel.PriceValue} pr liter")</span>
                    </li>
                }
            </ul>
        </div>

        <div style="flex: 1; border: 1px solid #ccc; border-radius: 8px; padding: 15px; max-height: 350px; overflow-y: auto; background-color: #f9f9f9;">
            <h3 style="margin-bottom: 10px;">Benzin</h3>
            <p><strong>Billigst:</strong> @MinGasPrice pr liter (@MinGasDate)</p>
            <p><strong>Dyrest:</strong> @MaxGasPrice pr liter (@MaxGasDate)</p>
            <ul style="list-style: none; padding: 0;">
                @foreach (var gas in gasData)
                {
                    <li style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #eee;">
                        <span>@gas.Date?.ToString("dd-MM-yyyy")</span>
                        <span>@(gas.PriceValue is null ? "-" : $"{gas.PriceValue} pr liter")</span>
                    </li>
                }
            </ul>
        </div>
    </div>

    <!-- Grafer -->
    <div class="row g-4">
        <div class="col-12 col-lg-6">
            <Card>
                <CardHeader>
                    <CardTitle>Diesel – prisudvikling</CardTitle>
                </CardHeader>
                <CardBody>
                    <!-- Korrekt Blazor Bootstrap chart-komponent -->
                    <LineChart @ref="dieselChart" Width="800" Height="260" />
                </CardBody>
            </Card>
        </div>

        <div class="col-12 col-lg-6">
            <Card>
                <CardHeader>
                    <CardTitle>Benzin – prisudvikling</CardTitle>
                </CardHeader>
                <CardBody>
                    <!-- Korrekt Blazor Bootstrap chart-komponent -->
                    <LineChart @ref="gasChart" Width="800" Height="260" />
                </CardBody>
            </Card>
        </div>
    </div>
}

@code {
    private List<Diesel>? dieselData;
    private List<Gas>? gasData;
    private string? ErrorMessage;

    // Min/Max (som før)
    private decimal MinDieselPrice => dieselData!.Min(d => d.PriceValue ?? decimal.MaxValue);
    private decimal MaxDieselPrice => dieselData!.Max(d => d.PriceValue ?? decimal.MinValue);
    private string? MinDieselDate => dieselData!.OrderBy(d => d.PriceValue ?? decimal.MaxValue).FirstOrDefault()?.Date?.ToString("dd-MM-yyyy");
    private string? MaxDieselDate => dieselData!.OrderByDescending(d => d.PriceValue ?? decimal.MinValue).FirstOrDefault()?.Date?.ToString("dd-MM-yyyy");

    private decimal MinGasPrice => gasData!.Min(g => g.PriceValue ?? decimal.MaxValue);
    private decimal MaxGasPrice => gasData!.Max(g => g.PriceValue ?? decimal.MinValue);
    private string? MinGasDate => gasData!.OrderBy(g => g.PriceValue ?? decimal.MaxValue).FirstOrDefault()?.Date?.ToString("dd-MM-yyyy");
    private string? MaxGasDate => gasData!.OrderByDescending(g => g.PriceValue ?? decimal.MinValue).FirstOrDefault()?.Date?.ToString("dd-MM-yyyy");

    // ---- Chart refs + data/options (Blazor Bootstrap API) ----
    private LineChart dieselChart = default!;
    private LineChart gasChart = default!;

    private LineChartOptions dieselChartOptions = default!;
    private LineChartOptions gasChartOptions = default!;

    private ChartData dieselChartData = default!;
    private ChartData gasChartData = default!;

    protected override async Task OnInitializedAsync()
    {
        dieselData = await APIService.GetDieselDataAsync();
        gasData = await APIService.GetGasDataAsync();

        if (dieselData == null || gasData == null)
        {
            ErrorMessage = "Failed to load fuel data.";
            return;
        }

        // Rens og sorter (stigende dato)
        dieselData = dieselData
            .Where(d => d.Date is not null && d.PriceValue is not null)
            .OrderBy(d => d.Date)
            .ToList();

        gasData = gasData
            .Where(g => g.Date is not null && g.PriceValue is not null)
            .OrderBy(g => g.Date)
            .ToList();

        BuildDieselChart();
        BuildGasChart();
    }

    // Init charts når DOM er klar (krav i BB charts)
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && dieselChartData is not null && gasChartData is not null)
        {
            await dieselChart.InitializeAsync(dieselChartData, dieselChartOptions);
            await gasChart.InitializeAsync(gasChartData, gasChartOptions);
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    private void BuildDieselChart()
    {
        var labels = dieselData!.Select(d => d.Date!.Value.ToString("dd-MM-yyyy")).ToList();
        var values = dieselData!.Select(d => (double?)Convert.ToDouble(d.PriceValue!.Value)).ToList();

        var dataset = new LineChartDataset
        {
            Label = "Diesel (kr/l)",
            Data = values,
            Tension = 0.25,
            Fill = true
        };

        dieselChartData = new ChartData
        {
            Labels = labels,
            Datasets = new List<IChartDataset> { dataset }
        };

        dieselChartOptions = new LineChartOptions
        {
            Responsive = true,
            Interaction = new Interaction { Mode = InteractionMode.Index, Intersect = false },
            Scales = new Scales
            {
                X = new ChartAxes { Title = new ChartAxesTitle { Text = "Dato", Display = true } },
                Y = new ChartAxes { Title = new ChartAxesTitle { Text = "Pris (kr/l)", Display = true } }
            },
            Plugins = new LineChartPlugins()
        };
        dieselChartOptions.Plugins.Title.Text = "Diesel – prisudvikling";
        dieselChartOptions.Plugins.Title.Display = true;
    }

    private void BuildGasChart()
    {
        var labels = gasData!.Select(g => g.Date!.Value.ToString("dd-MM-yyyy")).ToList();
        var values = gasData!.Select(g => (double?)Convert.ToDouble(g.PriceValue!.Value)).ToList();

        var dataset = new LineChartDataset
        {
            Label = "Benzin (kr/l)",
            Data = values,
            Tension = 0.25,
            Fill = true
        };

        gasChartData = new ChartData
        {
            Labels = labels,
            Datasets = new List<IChartDataset> { dataset }
        };

        gasChartOptions = new LineChartOptions
        {
            Responsive = true,
            Interaction = new Interaction { Mode = InteractionMode.Index, Intersect = false },
            Scales = new Scales
            {
                X = new ChartAxes { Title = new ChartAxesTitle { Text = "Dato", Display = true } },
                Y = new ChartAxes { Title = new ChartAxesTitle { Text = "Pris (kr/l)", Display = true } }
            },
            Plugins = new LineChartPlugins()
        };
        gasChartOptions.Plugins.Title.Text = "Benzin – prisudvikling";
        gasChartOptions.Plugins.Title.Display = true;
    }
}